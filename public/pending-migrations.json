{
  "version": "1.0",
  "lastUpdated": "2026-01-27T21:30:00Z",
  "description": "מיגרציות ממתינות להרצה - נוצר אוטומטית על ידי Copilot",
  "migrations": [
    {
      "id": "health_check_001",
      "name": "system_health_check_functions",
      "description": "יצירת פונקציות RPC לבדיקת תקינות מערכת - run_system_health_check() ו-quick_health_check()",
      "sql": "-- Drop existing function if exists\nDROP FUNCTION IF EXISTS public.run_system_health_check();\nDROP FUNCTION IF EXISTS public.quick_health_check();\n\n-- Create comprehensive health check function\nCREATE OR REPLACE FUNCTION public.run_system_health_check()\nRETURNS jsonb\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result jsonb := '{}'::jsonb;\n    table_stats jsonb := '[]'::jsonb;\n    index_stats jsonb := '[]'::jsonb;\n    constraint_issues jsonb := '[]'::jsonb;\n    rpc_functions jsonb := '[]'::jsonb;\n    policies_info jsonb := '[]'::jsonb;\n    recent_errors jsonb := '[]'::jsonb;\n    storage_info jsonb := '{}'::jsonb;\n    rec record;\n    total_rows bigint := 0;\n    total_size bigint := 0;\nBEGIN\n    -- TABLE STATISTICS\n    FOR rec IN \n        SELECT \n            t.table_name,\n            COALESCE(s.n_live_tup, 0) as row_count,\n            pg_size_pretty(pg_total_relation_size(quote_ident(t.table_name)::regclass)) as total_size,\n            pg_total_relation_size(quote_ident(t.table_name)::regclass) as size_bytes,\n            COALESCE(s.last_vacuum::text, 'Never') as last_vacuum,\n            COALESCE(s.last_analyze::text, 'Never') as last_analyze\n        FROM information_schema.tables t\n        LEFT JOIN pg_stat_user_tables s ON s.relname = t.table_name\n        WHERE t.table_schema = 'public' AND t.table_type = 'BASE TABLE'\n        ORDER BY COALESCE(s.n_live_tup, 0) DESC\n    LOOP\n        table_stats := table_stats || jsonb_build_object('name', rec.table_name, 'rows', rec.row_count, 'size', rec.total_size, 'size_bytes', rec.size_bytes, 'last_vacuum', rec.last_vacuum, 'last_analyze', rec.last_analyze);\n        total_rows := total_rows + rec.row_count;\n        total_size := total_size + rec.size_bytes;\n    END LOOP;\n\n    -- INDEX STATISTICS\n    FOR rec IN\n        SELECT tablename, indexname, pg_size_pretty(pg_relation_size(quote_ident(indexname)::regclass)) as index_size, idx_scan as times_used, CASE WHEN idx_scan = 0 THEN true ELSE false END as unused\n        FROM pg_stat_user_indexes WHERE schemaname = 'public' ORDER BY idx_scan ASC LIMIT 50\n    LOOP\n        index_stats := index_stats || jsonb_build_object('table', rec.tablename, 'index', rec.indexname, 'size', rec.index_size, 'times_used', rec.times_used, 'unused', rec.unused);\n    END LOOP;\n\n    -- FOREIGN KEY CONSTRAINTS\n    FOR rec IN\n        SELECT tc.table_name, kcu.column_name, ccu.table_name AS foreign_table_name, ccu.column_name AS foreign_column_name, tc.constraint_name\n        FROM information_schema.table_constraints AS tc\n        JOIN information_schema.key_column_usage AS kcu ON tc.constraint_name = kcu.constraint_name AND tc.table_schema = kcu.table_schema\n        JOIN information_schema.constraint_column_usage AS ccu ON ccu.constraint_name = tc.constraint_name AND ccu.table_schema = tc.table_schema\n        WHERE tc.constraint_type = 'FOREIGN KEY' AND tc.table_schema = 'public' ORDER BY tc.table_name\n    LOOP\n        constraint_issues := constraint_issues || jsonb_build_object('table', rec.table_name, 'column', rec.column_name, 'references_table', rec.foreign_table_name, 'references_column', rec.foreign_column_name, 'constraint', rec.constraint_name);\n    END LOOP;\n\n    -- RPC FUNCTIONS\n    FOR rec IN\n        SELECT p.proname as function_name, pg_get_function_arguments(p.oid) as arguments, pg_get_function_result(p.oid) as return_type, CASE p.prosecdef WHEN true THEN 'SECURITY DEFINER' ELSE 'SECURITY INVOKER' END as security\n        FROM pg_proc p JOIN pg_namespace n ON p.pronamespace = n.oid WHERE n.nspname = 'public' AND p.prokind = 'f' ORDER BY p.proname\n    LOOP\n        rpc_functions := rpc_functions || jsonb_build_object('name', rec.function_name, 'arguments', rec.arguments, 'returns', rec.return_type, 'security', rec.security);\n    END LOOP;\n\n    -- RLS POLICIES\n    FOR rec IN\n        SELECT schemaname, tablename, policyname, permissive, roles, cmd FROM pg_policies WHERE schemaname = 'public' ORDER BY tablename, policyname\n    LOOP\n        policies_info := policies_info || jsonb_build_object('table', rec.tablename, 'policy', rec.policyname, 'permissive', rec.permissive, 'roles', rec.roles, 'command', rec.cmd);\n    END LOOP;\n\n    -- RECENT MIGRATION LOGS\n    BEGIN\n        FOR rec IN SELECT name, executed_at, success, error FROM migration_logs ORDER BY executed_at DESC LIMIT 10\n        LOOP\n            recent_errors := recent_errors || jsonb_build_object('name', rec.name, 'executed_at', rec.executed_at, 'success', rec.success, 'error', rec.error);\n        END LOOP;\n    EXCEPTION WHEN undefined_table THEN recent_errors := '[]'::jsonb;\n    END;\n\n    -- DATABASE SIZE INFO\n    storage_info := jsonb_build_object('database_size', pg_size_pretty(pg_database_size(current_database())), 'database_size_bytes', pg_database_size(current_database()), 'total_tables', (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE'), 'total_rows', total_rows, 'total_data_size', pg_size_pretty(total_size));\n\n    -- BUILD FINAL RESULT\n    result := jsonb_build_object('timestamp', NOW(), 'database', current_database(), 'version', version(), 'status', 'OK', 'summary', jsonb_build_object('total_tables', jsonb_array_length(table_stats), 'total_rows', total_rows, 'total_functions', jsonb_array_length(rpc_functions), 'total_policies', jsonb_array_length(policies_info), 'total_foreign_keys', jsonb_array_length(constraint_issues), 'unused_indexes', (SELECT COUNT(*) FROM jsonb_array_elements(index_stats) elem WHERE (elem->>'unused')::boolean = true)), 'storage', storage_info, 'tables', table_stats, 'indexes', index_stats, 'foreign_keys', constraint_issues, 'functions', rpc_functions, 'policies', policies_info, 'recent_migrations', recent_errors);\n\n    RETURN result;\nEND;\n$$;\n\nGRANT EXECUTE ON FUNCTION public.run_system_health_check() TO authenticated;\nGRANT EXECUTE ON FUNCTION public.run_system_health_check() TO service_role;\n\n-- Quick Check Function\nCREATE OR REPLACE FUNCTION public.quick_health_check()\nRETURNS jsonb\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result jsonb;\n    issues jsonb := '[]'::jsonb;\n    tables_count int;\n    functions_count int;\n    policies_count int;\n    rec record;\nBEGIN\n    SELECT COUNT(*) INTO tables_count FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';\n    SELECT COUNT(*) INTO functions_count FROM pg_proc p JOIN pg_namespace n ON p.pronamespace = n.oid WHERE n.nspname = 'public' AND p.prokind = 'f';\n    SELECT COUNT(*) INTO policies_count FROM pg_policies WHERE schemaname = 'public';\n\n    FOR rec IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename NOT IN (SELECT DISTINCT tablename FROM pg_policies WHERE schemaname = 'public')\n    LOOP\n        issues := issues || jsonb_build_object('type', 'warning', 'message', 'Table without RLS policy: ' || rec.tablename);\n    END LOOP;\n\n    BEGIN\n        FOR rec IN SELECT name, error FROM migration_logs WHERE success = false AND executed_at > NOW() - INTERVAL '7 days'\n        LOOP\n            issues := issues || jsonb_build_object('type', 'error', 'message', 'Failed migration: ' || rec.name, 'details', rec.error);\n        END LOOP;\n    EXCEPTION WHEN undefined_table THEN NULL;\n    END;\n\n    result := jsonb_build_object('timestamp', NOW(), 'status', CASE WHEN jsonb_array_length(issues) = 0 THEN 'HEALTHY' ELSE 'ISSUES_FOUND' END, 'counts', jsonb_build_object('tables', tables_count, 'functions', functions_count, 'policies', policies_count), 'issues', issues, 'database_size', pg_size_pretty(pg_database_size(current_database())));\n\n    RETURN result;\nEND;\n$$;\n\nGRANT EXECUTE ON FUNCTION public.quick_health_check() TO authenticated;\nGRANT EXECUTE ON FUNCTION public.quick_health_check() TO service_role;",
      "createdAt": "2026-01-27T21:30:00Z",
      "priority": "high",
      "status": "pending"
    }
  ]
}