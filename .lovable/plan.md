
# תוכנית שדרוג מערכת ניהול מיגרציות מתקדמת

## סקירה כללית

שדרוג מערכת ניהול המיגרציות הקיימת ב-`DeveloperSettings.tsx` לכלי פיתוח מקצועי מלא הכולל:
- ניהול מלא של מיגרציות (צפייה, הרצה, מחיקה, תיקון)
- משוב ברור ומפורט עם פירוט שגיאות
- הרצת סקריפטים אינטראקטיבית דרך Edge Function
- תמיכה במספר מצבי הרצה (רגיל, Dry Run, Debug)

---

## שלב 1: שדרוג Edge Function `execute-sql`

**קובץ:** `supabase/functions/execute-sql/index.ts`

### תכונות חדשות:
```text
┌─────────────────────────────────────────────────────────────┐
│                    execute-sql v2.0                         │
├─────────────────────────────────────────────────────────────┤
│  mode: "execute" | "dry_run" | "explain" | "validate"       │
│  ───────────────────────────────────────────────────────────│
│  execute  → הרצה רגילה עם כתיבה לדאטאבייס                  │
│  dry_run  → בדיקה בלבד, ללא כתיבה (ROLLBACK)               │
│  explain  → החזרת תוכנית הרצה (EXPLAIN ANALYZE)            │
│  validate → בדיקת סינטקס בלבד                              │
├─────────────────────────────────────────────────────────────┤
│  תגובה מפורטת:                                             │
│  • execution_time_ms                                        │
│  • rows_affected                                            │
│  • warnings[]                                               │
│  • parsed_statements (מספר פקודות)                          │
│  • affected_tables[]                                        │
│  • error_details (מיקום שגיאה מדויק)                       │
└─────────────────────────────────────────────────────────────┘
```

### קוד לדוגמא:
```typescript
// מצב Dry Run - בדיקה בלבד
if (mode === 'dry_run') {
  await client.queryArray("BEGIN");
  try {
    const result = await client.queryObject(sql);
    await client.queryArray("ROLLBACK"); // לא שומר שינויים
    return { success: true, dry_run: true, would_affect: result.rowCount };
  } catch (err) {
    await client.queryArray("ROLLBACK");
    throw err;
  }
}

// מצב Explain - הסבר תוכנית הרצה
if (mode === 'explain') {
  const result = await client.queryObject(`EXPLAIN (ANALYZE, FORMAT JSON) ${sql}`);
  return { success: true, explain_plan: result.rows };
}
```

---

## שלב 2: שדרוג טבלת migration_logs

**מיגרציה נדרשת:**
```sql
-- הוספת עמודות חדשות לניהול מורחב
ALTER TABLE migration_logs ADD COLUMN IF NOT EXISTS 
  execution_time_ms INTEGER,
  mode TEXT DEFAULT 'execute',
  rollback_sql TEXT,
  status TEXT DEFAULT 'completed',
  metadata JSONB DEFAULT '{}';

-- יצירת אינדקס לחיפוש מהיר
CREATE INDEX IF NOT EXISTS idx_migration_logs_status 
  ON migration_logs(status);

CREATE INDEX IF NOT EXISTS idx_migration_logs_name 
  ON migration_logs(name);
```

---

## שלב 3: שדרוג רכיב MigrationManagement

**קובץ:** `src/components/settings/DeveloperSettings.tsx`

### ממשק משתמש חדש:

```text
┌──────────────────────────────────────────────────────────────────┐
│  🗄️ ניהול מיגרציות מתקדם                          [בדוק סטטוס]  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  📂 גרור קובץ SQL לכאן                                    │  │
│  │     או לחץ לבחירת קובץ                                     │  │
│  │     ─────────────────────                                   │  │
│  │     [📋 הדבק SQL] [📝 עורך מובנה]                         │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ══════════════════════════════════════════════════════════════  │
│                                                                  │
│  ┌──────────────── תצוגה מקדימה ────────────────┐               │
│  │  CREATE TABLE users (                        │               │
│  │    id UUID PRIMARY KEY,                      │               │
│  │    name TEXT NOT NULL                        │               │
│  │  );                                          │               │
│  │  ─────────────────────────────────────────── │               │
│  │  📊 ניתוח: 1 פקודה • טבלאות: users           │               │
│  └──────────────────────────────────────────────┘               │
│                                                                  │
│  ┌─────────────── אפשרויות הרצה ────────────────┐               │
│  │  ○ הרצה רגילה    ◉ הרצת בדיקה (Dry Run)     │               │
│  │  ○ הסבר תוכנית   ○ בדיקת סינטקס בלבד       │               │
│  └──────────────────────────────────────────────┘               │
│                                                                  │
│  [     ⚡ הרץ מיגרציה     ]  [🔍 בדוק תחילה]                    │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  📜 היסטוריית מיגרציות                           [🗑️ ניקוי]    │
├──────────────────────────────────────────────────────────────────┤
│  ┌─────┬──────────────────┬───────┬──────────┬─────────────────┐ │
│  │ סטט │ שם               │ מצב   │ זמן      │ פעולות          │ │
│  ├─────┼──────────────────┼───────┼──────────┼─────────────────┤ │
│  │ ✅  │ add_users_table  │ exec  │ 125ms    │ [👁️][🔄][🗑️]  │ │
│  │ ❌  │ broken_migration │ exec  │ 50ms     │ [👁️][⚠️ תקן]   │ │
│  │ ⏸️  │ pending_fix      │ dry   │ 80ms     │ [👁️][▶️ הרץ]   │ │
│  └─────┴──────────────────┴───────┴──────────┴─────────────────┘ │
│                                                                  │
│  📋 סה"כ: 47 מיגרציות • 45 הצלחות • 2 כשלונות                   │
└──────────────────────────────────────────────────────────────────┘
```

### תכונות חדשות:

**1. עורך SQL מובנה:**
- Syntax highlighting בסיסי
- מספור שורות
- השלמה אוטומטית בסיסית (CREATE, ALTER, DROP...)
- זיהוי שגיאות סינטקס בזמן אמת

**2. ניתוח SQL אוטומטי:**
```typescript
interface SqlAnalysis {
  statementCount: number;      // מספר פקודות
  affectedTables: string[];    // טבלאות מושפעות
  operationTypes: string[];    // CREATE, ALTER, DROP, INSERT...
  hasTransaction: boolean;     // האם כולל BEGIN/COMMIT
  estimatedRisk: 'low' | 'medium' | 'high';  // הערכת סיכון
  warnings: string[];          // אזהרות
}
```

**3. מצבי הרצה:**
- `execute` - הרצה רגילה
- `dry_run` - בדיקה ללא שמירה
- `explain` - הסבר תוכנית הרצה
- `validate` - בדיקת סינטקס בלבד

**4. משוב מפורט בשגיאות:**
```typescript
interface ErrorDetails {
  message: string;           // הודעת שגיאה
  code: string;             // קוד שגיאה (23505, 42P01...)
  position?: number;        // מיקום בשורה
  line?: number;            // מספר שורה
  hint?: string;            // הצעה לתיקון
  context?: string;         // הקשר נוסף
  suggestedFix?: string;    // תיקון מוצע אוטומטי
}
```

---

## שלב 4: פאנל פרטי שגיאה מורחב

**רכיב חדש:** `MigrationErrorPanel`

```text
┌──────────────────────────────────────────────────────────────────┐
│  ❌ המיגרציה נכשלה                                    [✕ סגור]  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  📛 שגיאה:                                                      │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ERROR: relation "users" already exists                    │  │
│  │  Code: 42P07                                               │  │
│  │  Position: Line 1, Character 14                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  💡 הצעה לתיקון:                                                │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  השתמש ב-"IF NOT EXISTS" כדי למנוע שגיאה זו:              │  │
│  │  CREATE TABLE IF NOT EXISTS users (...)                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  📍 מיקום השגיאה בקוד:                                          │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  1 │ CREATE TABLE users (                       ← כאן      │  │
│  │  2 │   id UUID PRIMARY KEY,                                │  │
│  │  3 │   name TEXT NOT NULL                                  │  │
│  │  4 │ );                                                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  [📋 העתק שגיאה]  [🔧 תקן אוטומטי]  [📖 תיעוד]                  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## שלב 5: ניהול היסטוריית מיגרציות

### פעולות על מיגרציות:

**1. צפייה בפרטים:**
- SQL מלא
- תוצאות הרצה
- זמן ביצוע
- משתמש מבצע

**2. הרצה מחדש:**
- הרץ שוב מיגרציה שנכשלה
- אפשרות להריץ עם שינויים

**3. מחיקת רשומות:**
- מחיקת רשומות ישנות
- ניקוי לוגים לפי תאריך
- מחיקת מיגרציות כושלות

**4. ייצוא:**
- ייצוא היסטוריה ל-JSON
- ייצוא SQL של מיגרציות מוצלחות

---

## שלב 6: Edge Function חדש להרצת סקריפטים כלליים

**קובץ חדש:** `supabase/functions/dev-scripts/index.ts`

### יכולות:
```typescript
// סוגי סקריפטים נתמכים
type ScriptType = 
  | 'sql'           // הרצת SQL
  | 'diagnostic'    // אבחון מערכת
  | 'cleanup'       // ניקוי נתונים
  | 'seed'          // הזנת נתוני בדיקה
  | 'backup'        // גיבוי
  | 'custom';       // סקריפט מותאם

interface DevScriptRequest {
  type: ScriptType;
  script?: string;
  options?: {
    dryRun?: boolean;
    verbose?: boolean;
    timeout?: number;
    targetTables?: string[];
  };
}
```

### סקריפטים מובנים:
- `diagnostic` - הרצת run_system_diagnostic
- `cleanup_old_logs` - ניקוי לוגים ישנים
- `vacuum_analyze` - אופטימיזציית דאטאבייס
- `check_constraints` - בדיקת אילוצים
- `list_orphans` - מציאת רשומות יתומות

---

## שלב 7: ממשק סקריפטים מובנה

**רכיב חדש:** `ScriptRunner`

```text
┌──────────────────────────────────────────────────────────────────┐
│  🔧 הרצת סקריפטים                                               │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────── סקריפטים מהירים ───────────┐                      │
│  │ [🔍 אבחון]  [🧹 ניקוי]  [📊 סטטיסטיקות] │                      │
│  │ [🔄 Vacuum] [⚠️ בדיקות] [📋 יתומים]    │                      │
│  └───────────────────────────────────────┘                      │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  // כתוב סקריפט מותאם                                      │  │
│  │  SELECT COUNT(*) FROM profiles;                            │  │
│  │  _                                                         │  │
│  │                                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ☑️ הרצת בדיקה    ☑️ פלט מפורט    Timeout: [30] שניות          │
│                                                                  │
│  [     ▶️ הרץ     ]                                             │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  📤 פלט:                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ✅ הסקריפט הורץ בהצלחה                                    │  │
│  │  ───────────────────────────────────────                   │  │
│  │  Execution time: 45ms                                      │  │
│  │  Rows returned: 1                                          │  │
│  │                                                            │  │
│  │  ┌─────────┐                                               │  │
│  │  │ count   │                                               │  │
│  │  ├─────────┤                                               │  │
│  │  │ 156     │                                               │  │
│  │  └─────────┘                                               │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

---

## סיכום קבצים לעדכון/יצירה

| קובץ | פעולה | תיאור |
|------|-------|-------|
| `supabase/functions/execute-sql/index.ts` | עדכון | תמיכה במצבים (dry_run, explain, validate) |
| `supabase/functions/dev-scripts/index.ts` | חדש | Edge Function להרצת סקריפטים כלליים |
| `src/components/settings/DeveloperSettings.tsx` | עדכון | שדרוג רכיב MigrationManagement |
| `src/components/settings/MigrationErrorPanel.tsx` | חדש | פאנל פרטי שגיאה מורחב |
| `src/components/settings/ScriptRunner.tsx` | חדש | ממשק הרצת סקריפטים |
| `src/components/settings/SqlEditor.tsx` | חדש | עורך SQL מובנה |
| `src/utils/sqlAnalyzer.ts` | חדש | ניתוח SQL אוטומטי |
| מיגרציה | חדש | הוספת עמודות ל-migration_logs |

---

## תוצאה צפויה

לאחר היישום:
1. ✅ העלאת והרצת מיגרציות עם משוב מפורט
2. ✅ מצב Dry Run לבדיקה בטוחה
3. ✅ ניתוח אוטומטי של SQL לפני הרצה
4. ✅ פאנל שגיאות מפורט עם הצעות תיקון
5. ✅ היסטוריה מלאה עם אפשרות מחיקה/תיקון
6. ✅ הרצת סקריפטים מותאמים אישית
7. ✅ סקריפטים מובנים לאבחון וניקוי
